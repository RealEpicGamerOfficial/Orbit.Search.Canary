<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- --- MOBILE VIEWPORT (Reverted as it was trash!) --- -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbit Search | Canary Version</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />

    <!-- --- ICON DEFINITIONS --- -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ü™ê</text></svg>">
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAMAAABswYX9AAAAnFBMVEUAAAAA/wAAfwAA/wBv7gC/3gDP/wBv7wCfxQDv9gBv/wCv/wDP9gC/9gD//wD3/wDv7wDP7wD///8A/wAA/wDP/wAAAAAA//8A/wAA/wD33wAA/wBv9wD/9wAA//8vAACfxQDv/wDP3wD3/wD37wAAvwD/7gBv/wDP/wDv/wD3/wAA/wD/3wAA7wAA/wAA/wAA/wAAvwDP9wD39wBv/wD/7wD/7wD39wAAvwAA/wDv7gAA/wA/v9AAAAAHDH39AAAALd0Uk5TAD8/TFBfX2BxcnN3f4CAgoOEhIWGh4mKjIyNjo+QkJOUlpaYmZyfoKChqKu0tbe5vLy+vsDBwsLDxMXGxsjKy83Ozs/Q0NHS09TV1tfY2drb3N3e3+Dg4uPk5ebn6Ojp6uxtr7S2uby9wMXGxsnKy8zNzs7Q0NHS1Nna3t7h4uPk5ebn6erq7e7v8PHy8/T19fb3+Pj5+vv8/f7+/v8+QEFERVJTVlheY2ZpbGxuaWlubm5ubnQzXnQAAAXCSur39AAAALd0Uk5TAD8/TFBfX2BxcnN3f4CAgoOEhIWGh4mKjIyNjo+QkJOUlpaYmZyfoKChqKu0tbe5vLy+vsDBwsLDxMXGxsnKy83Ozs/Q0NHS09TV1tfY2drb3N3e3+Dg4uPk5ebn6Ojp6uxtr7S2uby9wMXGxsnKy8zNzs7Q0NHS1Nna3t7h4uPk5ebn6erq7e7v8PHy8/T19fb3+Pj5+vv8/f7+/v8+QEFERVJTVlheY2ZpbGxuaWlubm5ubnQzXnQAAAYFSURBVHja7dwJc9pAFIZhdS9kH8hK4wP9oK1/E3Jd13a9l/t4l92+jLh9bA4Xg0FmE9e0mN66q7I4q2p3R82+t3t0/d59r98nJk+eYj7fTj3+gQ3xO987T3d3QW/36j9Y831k7vO88XzG4+8Qj78gE2bMmjR5ys75M2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2VryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZM2bNmjVryszZMy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLyEwCBFiB93MAYDMIGAwCDEBgAOizg8EEYGAAAACQVU5ErkJggg==">
    <link rel="manifest" href="data:application/json;base64,ewogICAgIm5hbWUiOiAiT3JiaXQgQnJvd3NlciIsCiAgICAic2hvcnRfbmFtZSI6ICJPcmJpdCIsCiAgICAiZGVzY3JpcHRpb24iOiAiQSBzZWN1cmUgYW5kIHByaXZhdGUgYnJvd3NlciBleHBlcmllbmNlLiIsCiAgICAic3RhcnRfdXJsIjogIi4iLAogICAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWExYTFhIiwKICAgICJ0aGVtZV9jb2xvciI6ICIjMWExYTFhIiwKICAgICJpY29ucyI6IFsKICAgICAgIHsKICAgICAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFDQUFBQUFnQ0FNQUFBQnZ3ZzBUQUFBQUJnbEJnbGtCZ2dEQUFBQllBTUFBQURVNmVWWlFBQUFBQUFBQUFBQUFBUXdBQUFBQVJZQ0FVUllBQUFCR0JBQUFBQkFBRVNJUWdBQUFBQUFBQUFBQUFVQ0FnQUFBQUFBRUFBQUFnQUF3QUFBQUFBRkFBUUFBREFBQUFBTEFBQUFBR0FBQUFBQUFBQUFBQzREQUFBQUFBQVFBQUFBQUFBR1JBQUFBQUFBQUFBQUFBQVFBQUFBQUFBQUFBQUFBR1lBQUFBQVFBQUFBQUFBQUFCQUFBSDBlQUFCWGdBQUE4RkFBQUFCSlVGRUJrSmdVQVFBQUFBQUFBQUFVU3UzUlRkWE02S043bkI3RzdiZ3htQUFBQUFkRlJTVW9SSUVGQlNnQURxVlVUkFzU0NrbFRRQUFBQUFGQlRVTGtRQUFBQUFBQUFBQUFBQUpZQUFBQUFBQUFBQUFBQUNRQUFBQUFBQUFBQUFBQUFBQUNBQWdBQUFBQUFBQUFBQUFBQUFBQUFad0FBQUFBQUFBQUFBQUFBQUFBTzBBQUFBQUFBQUFBQUFBQUFBQUFBQUFBRUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFHQmNmL2tBQkFBTUFsUVlYdkFRQUEvQUFBQ0YwVEFmZ0FBQUFBUUFBQUEwRkFBQUFBQVFBQUFBQUFBQUFBQUFBQUFBQVFBQWlBQUFBQUFBQUFBQUFBQUFBQUFHMEFBQUFBQUFBQUFBQUFBQUFBRzBCb1VBQXdDQUFBQUFBZ0FBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBSUVORFJCR2dnZyIsCiAgICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgICAgfSwKICAgICAgIHsKICAgICAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUEzQUFBQUNBQVk0QUFCeFVZWWdEQUFBQVZBQUFBZ0pQWFBCQUFBQUFBQUFBQkFBUWdBQUFBQUFBQUFBQUFBQUNBRUFBQUFBQUFBQUFBQUFBQUFBZ0FBQUFBQUFBQUFBQUFBQUFBQVFBQUFBQUFBQUFBQUFBQUFBQkFBT0VBQUJYb3dBQUF5SVBBQUFCZ0pPUEFsSUFBQUNBQUFBQUFBQUFBQVNBQUFBQVV3QUFBQUFBQUFBNkFBQUFDRXdBQUFBQUFBQUFOc0FBQUFBQUFBQUFBQUFBRTBBQUFBQUFBQUFBQUFBQUFBQUFBQUFBSUFBREVBQUFBQUFBQUFBQUFBQUFBQUFnQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBRG0wekF0UUVBUmdBQUFBMEtBQWdFQUFBQVlBQVFBQUFBQkFCVURtQUFBYWNBQUFBYmNBQUE0QUFLQlVvQUFBQmlKUlVGVFUxaEVBUUFBQUFBQUFBQUFLSlJBRERBQWdJQUFBQUFBZ0VBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUVQL0FBQUFBQUFBQUFBQUFBQUZBTmNBQUFBQUFBQUFBQUFBQUFBQmxWckFBRXhBQUFBRkpSRWhyRVNBZ0FBQUE9IiwKICAgICAgICAic2l6ZXMiOiAiNTEyeDUxMiIsCiAgICAgICAgInR5cGUiOiAiaW1wYWdlL3BuZyIKICAgICB9CiAgICBdCn0=">

    <style>
        /* --- THEME DEFINITIONS (CONTRAST FIX) --- */
        :root {
            /* Orbit Blue (from original file) */
            --orbit-blue: #4f46e5;
            --orbit-blue-darker: #4338ca;
            --orbit-blue-lighter: #6366f1;

            /* 1. Slate (Default) */
            --bg-slate: #1a1a1a;
            --container-slate: #2b2b2b;
            --text-slate: #e0e0e0;
            --accent-slate: var(--orbit-blue);
            --accent-hover-slate: var(--orbit-blue-lighter); /* Lighter hover for dark theme */
            --border-slate: #374151; /* gray-700 */
            --placeholder-slate: #6b7280;
            --tab-active-slate: #374151;
            --tab-inactive-slate: #1f2937;
            --tab-hover-slate: #4b5563;
            --bubble-ai-slate: #374151;

            /* 2. OLED */
            --bg-oled: #000000;
            --container-oled: #111111;
            --text-oled: #e0e0e0;
            --accent-oled: var(--orbit-blue);
            --accent-hover-oled: var(--orbit-blue-lighter);
            --border-oled: #222222;
            --placeholder-oled: #555555;
            --tab-active-oled: #1f1f1f;
            --tab-inactive-oled: #0a0a0a;
            --tab-hover-oled: #222222;
            --bubble-ai-oled: #1f1f1f;
            
            /* 3. Cosmic */
            --bg-cosmic: linear-gradient(-45deg, #020024, #090979, #00d4ff);
            --container-cosmic: rgba(10, 10, 40, 0.8);
            --text-cosmic: #f0f0ff;
            --accent-cosmic: var(--orbit-blue-lighter); /* Lighter blue for dark bg */
            --accent-hover-cosmic: #818cf8; /* Even lighter */
            --border-cosmic: #4c1d95; /* Violet-800 */
            --placeholder-cosmic: #a78bfa; /* Violet-300 */
            --tab-active-cosmic: rgba(50, 20, 100, 0.9);
            --tab-inactive-cosmic: rgba(30, 10, 80, 0.8);
            --tab-hover-cosmic: rgba(70, 40, 120, 0.9);
            --bubble-ai-cosmic: #3730a3; /* Indigo-800 */

            /* 4. Snow (Light) */
            --bg-snow: #f4f7f6;
            --container-snow: #ffffff;
            --text-snow: #1f2937; /* Gray-800 */
            --accent-snow: var(--orbit-blue);
            --accent-hover-snow: var(--orbit-blue-darker); /* Darker hover for light theme */
            --border-snow: #d1d5db; /* Gray-300 */
            --placeholder-snow: #9ca3af; /* Gray-400 */
            --tab-active-snow: #f3f4f6; /* Gray-100 */
            --tab-inactive-snow: #e5e7eb; /* Gray-200 */
            --tab-hover-snow: #d1d5db;
            --bubble-ai-snow: #f3f4f6;
        }

        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll */
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            /* Default background (Slate) */
            background: var(--bg-slate);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-slate);
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* --- DYNAMIC THEME STYLING --- */
        /* This is the magic. JS will set variables on the body tag. */
        body {
            background: var(--bg-theme);
            color: var(--text-theme);
        }
        
        /* Stop animation for non-gradient themes */
        body.theme-oled, body.theme-snow {
             background-size: auto !important;
             animation: none !important;
        }
        
        /* Cosmic needs its animation */
        body.theme-cosmic {
            background: var(--bg-cosmic);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        
        /* === PRIVACY+ MODE OVERRIDE (REMOVED) === */
        /* Privacy+ mode no longer overrides theme */
        
        /* --- COMPONENT STYLING (uses theme variables) --- */
        .container-bg { background-color: var(--container-theme); }
        .text-color { color: var(--text-theme); }
        .border-color { border-color: var(--border-theme); }
        .accent-bg { background-color: var(--accent-theme); }
        .accent-bg-hover:hover { background-color: var(--accent-hover-theme); }
        .accent-text { color: var(--accent-theme); }
        .accent-border-focus:focus-within { border-color: var(--accent-theme); }
        .placeholder-color::placeholder { color: var(--placeholder-theme); }
        .tab-active { background-color: var(--tab-active-theme); color: var(--text-theme); }
        .tab-inactive { background-color: var(--tab-inactive-theme); color: var(--placeholder-theme); }
        .tab-inactive:hover { background-color: var(--tab-hover-theme); }
        .modal-bg { background-color: var(--container-theme); }
        .radio-label { background-color: var(--border-theme); border-color: var(--border-theme); }
        
        /* Settings Button Selection Style */
        .radio-label-checked { 
            background-color: var(--accent-theme); 
            border-color: var(--accent-hover-theme); 
            color: #ffffff !important; /* Force high-contrast text */
            box-shadow: 0 0 0 2px var(--accent-hover-theme);
        }
        .radio-label-checked span {
            color: #ffffff !important; /* Force high-contrast text for child spans */
            opacity: 1 !important;
        }

        .toggle-label { background-color: var(--border-theme); }
        .toggle-checkbox:checked + .toggle-label { background-color: var(--accent-theme); }
        .luna-sidebar { background-color: var(--container-theme); border-left-color: var(--border-theme); }
        .luna-bubble-user { background-color: var(--accent-theme); }
        .luna-bubble-ai { background-color: var(--bubble-ai-theme); }
        .engine-grid-item { background-color: var(--border-theme); }
        .engine-grid-item:hover { background-color: var(--tab-hover-theme); }
        .engine-grid-item.selected { background-color: var(--accent-theme); }

        /* General UI fixes */
        .iframe-container {
            flex-grow: 1;
            height: 100%;
            width: 100%;
        }
        iframe {
            height: 100%;
            width: 100%;
            border: none;
            background-color: #fff; /* White background for loading */
        }
        #tab-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .new-tab-page {
            flex-grow: 1; /* Make new tab page fill remaining space */
        }

        /* --- MODE-BASED VISIBILITY --- */
        
        /* Hide tabs/navbar in classic and privacy modes */
        body.mode-classic #tab-bar,
        body.mode-classic #navbar,
        body.mode-privacy-plus #tab-bar,
        body.mode-privacy-plus #navbar {
            display: none;
        }
        body.mode-classic #app-container,
        body.mode-privacy-plus #app-container {
            height: 100vh;
        }
        
        /* Show tabs/navbar in web-browser mode */
        body.mode-web-browser #tab-bar {
            display: flex;
        }
        body.mode-web-browser #navbar {
            display: flex; /* Show new navbar */
        }
        body.mode-web-browser #app-container {
            height: 100vh;
        }
        
        /* Engine visibility rules */
        .engine-button { display: none; }
        body.mode-classic .engine-button { display: flex; }
        body.mode-privacy-plus .engine-button[data-engine="startpage"] { display: flex; }
        body.mode-web-browser .engine-button[data-engine="bing"] { display: flex; }

        /* Luna AI Panel */
        #luna-ai-panel {
            transition: transform 0.3s ease-in-out;
            transform: translateX(100%);
        }
        #luna-ai-panel.open {
            transform: translateX(0);
        }

        /* Toggle switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: var(--accent-theme);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: var(--accent-theme);
        }
        
        /* Simple scrollbar for modals/history */
        .simple-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .simple-scrollbar::-webkit-scrollbar-thumb {
            background: var(--border-theme);
            border-radius: 4px;
        }
        .simple-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--placeholder-theme);
        }

    </style>
</head>
<body class="theme-slate"> <!-- Default to slate, JS will override -->

    <div id="app-container" class="flex flex-col h-screen max-h-screen">

        <!-- Tab Bar (Hidden by default) -->
        <div id="tab-bar" class="w-full container-bg border-b border-color flex items-center space-x-1 p-1">
            <div id="tabs-container" class="flex-grow flex space-x-1 overflow-x-auto">
                <!-- Tabs will be dynamically inserted here -->
            </div>
            <button id="add-tab-button" class="flex-shrink-0 p-2 text-color hover:bg-gray-700 rounded-md">
                <span class="material-symbols-outlined text-base">add</span>
            </button>
        </div>
        
        <!-- Navbar (Hidden by default, for Web Browser Mode) -->
        <div id="navbar" class="w-full container-bg border-b border-color flex items-center p-2 space-x-2">
            <!-- Nav buttons -->
            <button id="nav-back" class="p-2 text-color rounded-md hover:bg-gray-700 disabled:opacity-30" disabled><span class="material-symbols-outlined">arrow_back</span></button>
            <button id="nav-forward" class="p-2 text-color rounded-md hover:bg-gray-700 disabled:opacity-30" disabled><span class="material-symbols-outlined">arrow_forward</span></button>
            <button id="nav-reload" class="p-2 text-color rounded-md hover:bg-gray-700"><span class="material-symbols-outlined">refresh</span></button>
            
            <!-- URL/Search Bar -->
            <input id="navbar-search" type="text" class="flex-grow p-2 rounded-md bg-gray-700 border border-transparent focus:border-blue-500 text-color placeholder-color" placeholder="Search or type URL...">
            
            <!-- Action buttons -->
            <button id="nav-add-bookmark" class="p-2 text-color rounded-md hover:bg-gray-700"><span class="material-symbols-outlined">bookmark_add</span></button>
            <button id="nav-bookmarks" class="p-2 text-color rounded-md hover:bg-gray-700"><span class="material-symbols-outlined">bookmarks</span></button>
            <button id="nav-history" class="p-2 text-color rounded-md hover:bg-gray-700"><span class="material-symbols-outlined">history</span></button>
            <button id="nav-settings" class="p-2 text-color rounded-md hover:bg-gray-700"><span class="material-symbols-outlined">settings</span></button>
        </div>

        <!-- Tab Content Area -->
        <div id="tab-content" class="w-full h-full relative flex-grow">
            <!-- Iframes and New Tab Page will be dynamically shown/hidden here -->
        </div>

        <!-- Luna AI Chat Panel (Hidden by default) -->
        <!-- MOBILE RESPONSIVE: w-full sm:max-w-md -->
        <div id="luna-ai-panel" class="luna-sidebar fixed top-0 right-0 h-full w-full sm:max-w-md border-color z-50 flex flex-col transform translate-x-full">
            <!-- Header -->
            <div class="flex items-center justify-between p-4 border-b border-color flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <span class="material-symbols-outlined accent-text text-2xl">moon_stars</span>
                    <h2 class="text-lg font-semibold text-color">Luna AI</h2>
                </div>
                <button id="luna-close-button" class="text-color opacity-70 hover:opacity-100">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            
            <!-- Chat Area -->
            <div id="luna-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto simple-scrollbar">
                <!-- Initial Message -->
                <div class="flex">
                    <div class="luna-bubble-ai text-color p-3 rounded-lg rounded-bl-none max-w-xs">
                        <p>Hi! I'm Luna. Ask me anything, or just say hello!</p>
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="p-4 border-t border-color flex-shrink-0">
                <div class="flex items-center space-x-2">
                    <input type="text" id="luna-input" class="flex-grow p-2 rounded-lg border border-color container-bg text-color placeholder-color focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Type your message...">
                    <button id="luna-send-button" class="p-2 rounded-lg accent-bg accent-bg-hover text-white">
                        <span class="material-symbols-outlined">arrow_upward</span>
                    </button>
                </div>
            </div>
        </div>

    </div> <!-- End App Container -->


    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4 overflow-y-auto" style="backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);">
        <!-- MOBILE: max-h-[90vh] overflow-y-auto -->
        <div class="modal-bg p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md border border-color space-y-6 max-h-[90vh] overflow-y-auto simple-scrollbar">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-color">Settings</h2>
                <button id="settings-close-button" class="text-color opacity-70 hover:opacity-100 text-3xl p-1 leading-none transition-colors">&times;</button>
            </div>

            <!-- Separator -->
            <div class="border-t border-color"></div>
            
            <!-- General Settings -->
            <fieldset class="space-y-4">
                <legend class="text-lg font-medium text-color mb-3">General</legend>
                <p class="text-sm text-color opacity-70 -mt-2">Core browser behavior.</p>
                
                <div>
                    <label class="text-md font-medium text-color mb-2 block">Experience Mode</label>
                    <input type="radio" id="mode-classic" name="browser-mode" value="classic" class="sr-only peer">
                    <label for="mode-classic" class="radio-label block p-4 rounded-lg border cursor-pointer peer-checked:radio-label-checked">
                        <span class="block text-md font-semibold text-color">Classic Mode</span>
                        <span class="block text-sm text-color opacity-70">Simple search page. Results open in new tab.</span>
                    </label>
                </div>
                <div>
                    <input type="radio" id="mode-web-browser" name="browser-mode" value="web-browser" class="sr-only peer">
                    <label for="mode-web-browser" class="radio-label block p-4 rounded-lg border cursor-pointer peer-checked:radio-label-checked">
                        <span class="block text-md font-semibold text-color">Web Browser Mini</span>
                        <span class="block text-sm text-color opacity-70">Keep results in-app with tabs. Uses Bing.</span>
                    </label>
                </div>
                <div>
                    <input type="radio" id="mode-privacy-plus" name="browser-mode" value="privacy-plus" class="sr-only peer">
                    <label for="mode-privacy-plus" class="radio-label block p-4 rounded-lg border cursor-pointer peer-checked:radio-label-checked">
                        <span class="block text-md font-semibold text-color">Privacy+ Mode</span>
                        <span class="block text-sm text-color opacity-70">Search with Startpage. Pitch black theme.</span>
                    </label>
                </div>
            </fieldset>

            <!-- Separator -->
            <div class="border-t border-color"></div>

            <!-- Appearance -->
            <fieldset class="space-y-4">
                <legend class="text-lg font-medium text-color mb-3">Appearance</legend>
                
                <div>
                    <label for="theme-select" class="text-md font-medium text-color mb-2 block">Theme</label>
                    <select id="theme-select" class="w-full p-3 rounded-lg border border-color container-bg text-color focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="slate">Slate (Default)</option>
                        <option value="oled">OLED (Black)</option>
                        <option value="cosmic">Cosmic</option>
                        <option value="snow">Snow (Light)</option>
                    </select>
                </div>
                
                <div>
                    <label class="text-md font-medium text-color mb-2 block">Widget</label>
                    <input type="radio" id="widget-off" name="widget-mode" value="off" class="sr-only peer">
                    <label for="widget-off" class="radio-label inline-block p-3 rounded-lg border cursor-pointer peer-checked:radio-label-checked mr-2"><span class="font-semibold text-color">Off</span></label>
                    
                    <input type="radio" id="widget-time" name="widget-mode" value="time" class="sr-only peer">
                    <label for="widget-time" class="radio-label inline-block p-3 rounded-lg border cursor-pointer peer-checked:radio-label-checked"><span class="font-semibold text-color">Time & Date</span></label>
                    <!-- Add more widgets here -->
                </div>
                
                <div class="flex items-center justify-between pt-2">
                    <label for="luna-toggle" class="text-md font-medium text-color">Enable Luna AI Button</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none">
                        <input type="checkbox" name="luna-toggle" id="luna-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="luna-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label>
                    </div>
                </div>

            </fieldset>

            <!-- Separator -->
            <div class="border-t border-color"></div>
            
            <!-- Privacy & Security -->
            <fieldset class="space-y-4">
                <legend class="text-lg font-medium text-color mb-3">Privacy & Security</legend>

                <div class="flex items-center justify-between">
                    <label for="history-toggle" class="text-md font-medium text-color">Enable Search History</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none">
                        <input type="checkbox" name="history-toggle" id="history-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="history-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label>
                    </div>
                </div>
                <p class="text-sm text-color opacity-70 -mt-2">Saves your last 25 search queries.</p>

                <div class="flex items-center justify-between">
                    <label for="force-https-toggle" class="text-md font-medium text-color">Force HTTPS</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none">
                        <input type="checkbox" name="force-https-toggle" id="force-https-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                        <label for="force-https-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label>
                    </div>
                </div>
                <p class="text-sm text-color opacity-70 -mt-2">Blocks insecure sites in Web Browser mode.</p>

                <div class="flex items-center justify-between opacity-70 cursor-not-allowed">
                    <label for="safe-search-toggle" class="text-md font-medium text-color">Enable SafeSearch</label>
                    <div class="relative inline-block w-10 mr-2 align-middle select-none">
                        <input type="checkbox" id="safe-search-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none" checked disabled/>
                        <label for="safe-search-toggle" class="toggle-label block overflow-hidden h-6 rounded-full"></label>
                    </div>
                </div>
                <p class="text-sm text-color opacity-70 -mt-2">SafeSearch is always on.</p>

            </fieldset>

            <button id="settings-save-button" class="w-full p-3 accent-bg text-white font-semibold rounded-lg accent-bg-hover transition-colors">
                Save & Close
            </button>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" style="backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);">
        <div class="modal-bg p-6 rounded-xl shadow-2xl w-full max-w-md border border-color flex flex-col max-h-[70vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-color">Search History</h2>
                <button id="history-close-button" class="text-color opacity-70 hover:opacity-100 text-3xl p-1 leading-none">&times;</button>
            </div>
            <div id="history-list" class="overflow-y-auto space-y-3 simple-scrollbar pr-2">
                <!-- History items will be injected here -->
                <p class="text-color opacity-70">No history found.</p>
            </div>
            <button id="history-clear-button" class="mt-4 w-full p-2 accent-bg accent-bg-hover text-white font-semibold rounded-lg transition-colors">Clear History</button>
        </div>
    </div>
    
    <!-- Bookmarks Modal -->
    <div id="bookmarks-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4" style="backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);">
        <div class="modal-bg p-6 rounded-xl shadow-2xl w-full max-w-md border border-color flex flex-col max-h-[70vh]">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-color">Bookmarks</h2>
                <button id="bookmarks-close-button" class="text-color opacity-70 hover:opacity-100 text-3xl p-1 leading-none">&times;</button>
            </div>
            <div id="bookmarks-list" class="overflow-y-auto space-y-3 simple-scrollbar pr-2">
                <!-- Bookmarks will be injected here -->
                <p class="text-color opacity-70">No bookmarks added yet.</p>
            </div>
        </div>
    </div>
    
    <!-- Luna AI Toggle Button (Hidden by default) -->
    <button id="luna-button" class="hidden fixed bottom-6 right-6 p-3 rounded-full accent-bg accent-bg-hover text-white shadow-lg transition-transform hover:scale-110 z-40 flex flex-col items-center justify-center w-16 h-16">
        <span class="material-symbols-outlined text-2xl">moon_stars</span>
        <span class="text-xs font-medium">Luna</span>
    </button>
    
    <!-- Privacy Mode Watermark -->
    <div id="privacy-watermark" class="fixed bottom-2 left-2 text-xs text-gray-700 opacity-70 hidden">
        Orbit_V.1.8/PrivacyMode
    </div>


    <!-- New Tab Page Template -->
    <template id="new-tab-template">
        <!-- MOBILE: Reverted pt-12 -->
        <div class="new-tab-page w-full h-full flex flex-col items-center justify-center p-4 overflow-y-auto simple-scrollbar">
            
            <!-- Widget Container -->
            <div class="widget-container w-full max-w-lg text-center mb-8 h-24">
                <!-- Widgets will be injected here by JS -->
            </div>

            <!-- Logo -->
            <!-- MOBILE: Reverted to text-8xl -->
            <div class="flex-grow flex flex-col justify-center items-center w-full">
                <h1 class="text-8xl font-bold text-color opacity-90 mb-8 flex items-center">
                    <span class="accent-text">O</span>rbit
                </h1>
                
                <!-- New Tab Button Bar -->
                <div class="flex space-x-4 mb-8">
                    <button class="new-tab-settings-button p-3 rounded-full text-color opacity-70 hover:opacity-100 hover:bg-gray-700 transition-colors" title="Settings">
                        <span class="material-symbols-outlined">settings</span>
                    </button>
                    <button class="new-tab-bookmarks-button p-3 rounded-full text-color opacity-70 hover:opacity-100 hover:bg-gray-700 transition-colors" title="Bookmarks">
                        <span class="material-symbols-outlined">bookmarks</span>
                    </button>
                    <button class="new-tab-history-button p-3 rounded-full text-color opacity-70 hover:opacity-100 hover:bg-gray-700 transition-colors" title="History">
                        <span class="material-symbols-outlined">history</span>
                    </button>
                </div>


                <!-- Search Bar -->
                <div class="w-full max-w-lg">
                    <div class="search-container accent-border-focus flex items-center container-bg rounded-full shadow-lg overflow-hidden border-2 border-transparent transition-all duration-300">
                        <input type="text" class="search-input w-full p-4 bg-transparent text-color placeholder-color focus:outline-none" placeholder="Search for anything...">
                        <button class="search-button p-4 text-color opacity-70 hover:opacity-100 transition-colors">
                            <span class="material-symbols-outlined">search</span>
                        </button>
                    </div>
                    <div class="message-area hidden text-red-400 text-center mt-2"></div>
                </div>

                <!-- Search Engines -->
                <!-- MOBILE: Reverted to grid-cols-4 -->
                <div class="engine-grid grid grid-cols-4 gap-3 mt-8 w-full max-w-lg px-4">
                    <button data-engine="google" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="https://www.google.com/s2/favicons?domain=google.com&sz=32" alt="Google" class="h-8 w-8 mb-2">
                        <span class="text-sm font-medium text-color">Google</span>
                    </button>
                    <button data-engine="bing" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="https://www.google.com/s2/favicons?domain=bing.com&sz=32" alt="Bing" class="h-8 w-8 mb-2">
                        <span class="text-sm font-medium text-color">Bing</span>
                    </button>
                    <button data-engine="duckduckgo" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="https://www.google.com/s2/favicons?domain=duckduckgo.com&sz=32" alt="DuckDuckGo" class="h-8 w-8 mb-2">
                        <span class="text-sm font-medium text-color">DuckDuckGo</span>
                    </button>
                    <button data-engine="brave" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="https://www.google.com/s2/favicons?domain=brave.com&sz=32" alt="Brave" class="h-8 w-8 mb-2">
                        <span class="text-sm font-medium text-color">Brave</span>
                    </button>
                    <button data-engine="ecosia" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="httpsG&t;:/&amp;#x2F;&#x2F;www.google.com/s2/favicons?domain=ecosia.org&sz=32" alt="Ecosia" class="h-8 w-8 mb-2" onerror="this.src='https://placehold.co/32x32/2b2b2b/e0e0e0?text=E'">
                        <span class="text-sm font-medium text-color">Ecosia</span>
                    </button>
                    <button data-engine="qwant" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="https://www.google.com/s2/favicons?domain=qwant.com&sz=32" alt="Qwant" class="h-8 w-8 mb-2">
                        <span class="text-sm font-medium text-color">Qwant</span>
                    </button>
                    <button data-engine="yahoo" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="https://www.google.com/s2/favicons?domain=yahoo.com&sz=32" alt="Yahoo" class="h-8 w-8 mb-2">
                        <span class="text-sm font-medium text-color">Yahoo</span>
                    </button>
                    <button data-engine="startpage" class="engine-button engine-grid-item p-4 rounded-lg shadow transition-all duration-200 flex flex-col items-center justify-center">
                        <img src="https://www.google.com/s2/favicons?domain=startpage.com&sz=32" alt="Startpage" class="h-8 w-8 mb-2">
                        <span class="text-sm font-medium text-color">Startpage</span>
                    </button>
                </div>
            </div>

        </div>
    </template>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- Global State ---
        let currentEngine = 'google';
        let currentMode = 'classic';
        let currentTheme = 'slate'; // NEW: Default theme
        let safeSearchEnabled = true; // Hard-enforced
        let forceHttps = true;
        let currentWidget = 'off';
        let lunaEnabled = false; // NEW: Default off
        let historyEnabled = true; // NEW: Default on
        let searchHistory = []; // NEW
        let bookmarks = []; // NEW
        
        let tabCounter = 0;
        let activeTabId = null;
        let placeholderInterval;

        // --- DOM Elements ---
        const body = document.body;
        const appContainer = document.getElementById('app-container');
        const tabContainer = document.getElementById('tabs-container');
        const tabContent = document.getElementById('tab-content');
        const addTabButton = document.getElementById('add-tab-button');
        const newTabTemplate = document.getElementById('new-tab-template');
        
        // Web-browser Navbar
        const navbar = document.getElementById('navbar');
        const navBack = document.getElementById('nav-back');
        const navForward = document.getElementById('nav-forward');
        const navReload = document.getElementById('nav-reload');
        const navbarSearch = document.getElementById('navbar-search');
        const navAddBookmark = document.getElementById('nav-add-bookmark');
        const navBookmarks = document.getElementById('nav-bookmarks');
        const navHistory = document.getElementById('nav-history');
        const navSettings = document.getElementById('nav-settings');

        // Settings Modal
        const settingsModal = document.getElementById('settings-modal');
        const settingsCloseButton = document.getElementById('settings-close-button');
        const settingsSaveButton = document.getElementById('settings-save-button');
        const themeSelect = document.getElementById('theme-select');
        const historyToggle = document.getElementById('history-toggle');
        const lunaToggle = document.getElementById('luna-toggle');
        const forceHttpsToggle = document.getElementById('force-https-toggle');
        
        // History Modal
        const historyModal = document.getElementById('history-modal');
        const historyList = document.getElementById('history-list');
        const historyCloseButton = document.getElementById('history-close-button');
        const historyClearButton = document.getElementById('history-clear-button');
        
        // Bookmarks Modal
        const bookmarksModal = document.getElementById('bookmarks-modal');
        const bookmarksList = document.getElementById('bookmarks-list');
        const bookmarksCloseButton = document.getElementById('bookmarks-close-button');
        
        // Watermark
        const privacyWatermark = document.getElementById('privacy-watermark');

        // Luna AI Elements
        const lunaButton = document.getElementById('luna-button');
        const lunaPanel = document.getElementById('luna-ai-panel');
        const lunaCloseButton = document.getElementById('luna-close-button');
        const lunaSendButton = document.getElementById('luna-send-button');
        const lunaInput = document.getElementById('luna-input');
        const lunaChatMessages = document.getElementById('luna-chat-messages');
        
        // Search Engines
        const searchEngines = {
            google: "https://www.google.com/search?q=",
            bing: "https://www.bing.com/search?q=",
            duckduckgo: "https://duckduckgo.com/?q=",
            brave: "https://search.brave.com/search?q=",
            ecosia: "https://www.ecosia.org/search?q=",
            qwant: "https://www.qwant.com/?q=",
            yahoo: "https://search.yahoo.com/search?p=",
            startpage: "https://www.startpage.com/search?q="
        };

        // --- SafeSearch Blocklist ---
        const blockedTerms = [
            'porn', 'xxx', 'sex', 'nsfw', 'explicit', // Add more sensitive terms as needed
        ];

        function checkSafeSearch(query) {
            const lowerQuery = query.toLowerCase();
            return blockedTerms.some(term => lowerQuery.includes(term));
        }
        
        // --- COOKIE HELPER FUNCTIONS ---
        function setCookie(name, value, days) {
            let expires = "";
            if (days) {
                let date = new Date();
                date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            // Use SameSite=Lax and Secure if not on localhost (though this demo runs locally)
            document.cookie = name + "=" + (value || "") + expires + "; path=/; SameSite=Lax";
        }

        function getCookie(name) {
            let nameEQ = name + "=";
            let ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        // --- Placeholder Cycling ---
        const placeholders = [
            "What is the capital of Canada?",
            "How many days until halloween",
            "Google Calendar",
            "ChromeOS",
            "Search for anything, the web is at your fingertips"
        ];
        let placeholderIndex = 0;

        function updatePlaceholder() {
            const inputs = document.querySelectorAll('.search-input');
            if (inputs.length > 0) {
                placeholderIndex = (placeholderIndex + 1) % placeholders.length;
                const newPlaceholder = placeholders[placeholderIndex];
                inputs.forEach(input => {
                    if (document.activeElement !== input) {
                        input.placeholder = newPlaceholder;
                    }
                });
            }
            // Update navbar search placeholder too
            if (navbarSearch && document.activeElement !== navbarSearch) {
                navbarSearch.placeholder = placeholders[placeholderIndex];
            }
        }
        
        function startPlaceholderCycling() {
            if (placeholderInterval) clearInterval(placeholderInterval);
            placeholderInterval = setInterval(updatePlaceholder, 3000);
        }

        // --- Core Functions ---

        function performSearch(query, engine) {
            const rawQuery = query.trim();
            const activeContent = document.getElementById(activeTabId);
            if (!activeContent) return; 
            
            const messageArea = activeContent.querySelector('.message-area');
            if (messageArea) messageArea.classList.add('hidden');

            if (rawQuery === "") {
                if (messageArea) {
                    messageArea.textContent = 'Please enter a search term.';
                    messageArea.classList.remove('hidden');
                }
                return;
            }

            if (safeSearchEnabled && checkSafeSearch(rawQuery)) {
                if (messageArea) {
                    messageArea.textContent = 'Your search contains words that are not allowed. Please try again.';
                    messageArea.classList.remove('hidden');
                }
                return;
            }

            const searchUrl = searchEngines[engine] + encodeURIComponent(rawQuery);
            
            // --- HISTORY: Add to history ---
            if (historyEnabled) {
                const historyItem = {
                    query: rawQuery,
                    engine: engine,
                    url: searchUrl,
                    timestamp: new Date().toISOString()
                };
                searchHistory.unshift(historyItem); // Add to start
                searchHistory = searchHistory.slice(0, 25); // Limit to 25
                saveListsToCookies(); // Save
            }

            if (currentMode === 'classic' || currentMode === 'privacy-plus') {
                window.open(searchUrl, '_blank');
            } else if (currentMode === 'web-browser') {
                createNewTab(true, searchUrl);
            }
        }
        
        // --- Search/Navigate from Navbar ---
        function handleNavbarSearch() {
            const query = navbarSearch.value.trim();
            if (query === "") return;
            
            let url;
            // Basic URL check
            if (query.includes('.') || query.startsWith('http')) {
                url = query.startsWith('http') ? query : `https://${query}`;
            } else {
                // Use default engine (Bing for this mode)
                url = searchEngines['bing'] + encodeURIComponent(query);
            }
            
            // Navigate active iframe
            const activeContent = document.getElementById(activeTabId);
            if (activeContent) {
                const iframe = activeContent.querySelector('iframe');
                if (iframe) {
                    // This is a navigation, not a "New Tab"
                    navigateTo(url, activeTabId, true);
                } else {
                    // If on a "New Tab" page, create a new tab with the search
                    createNewTab(true, url);
                }
            }
        }

        // --- Settings ---
        function openSettings() {
            // Set current values in the modal
            document.getElementById(`mode-${currentMode}`).checked = true;
            document.getElementById(`widget-${currentWidget}`).checked = true;
            themeSelect.value = currentTheme;
            historyToggle.checked = historyEnabled;
            lunaToggle.checked = lunaEnabled;
            forceHttpsToggle.checked = forceHttps;

            settingsModal.classList.remove('hidden');
        }

        function closeSettings() {
            settingsModal.classList.add('hidden');
        }

        function saveSettings() {
            // Get selected mode
            const selectedMode = document.querySelector('input[name="browser-mode"]:checked').value;
            const oldMode = currentMode;
            setCookie('orbit-mode', selectedMode, 365);
            currentMode = selectedMode;

            // Get Theme
            currentTheme = themeSelect.value;
            setCookie('orbit-theme', currentTheme, 365);
            
            // Get Toggles
            historyEnabled = historyToggle.checked;
            setCookie('orbit-history-enabled', historyEnabled, 365);
            
            lunaEnabled = lunaToggle.checked;
            setCookie('orbit-luna-enabled', lunaEnabled, 365);

            forceHttps = forceHttpsToggle.checked;
            setCookie('orbit-force-https', forceHttps, 365);
            
            // Get Widget
            const selectedWidget = document.querySelector('input[name="widget-mode"]:checked').value;
            setCookie('orbit-widget', selectedWidget, 365);
            currentWidget = selectedWidget;

            // Close modal
            closeSettings();
            
            // Apply theme and Luna setting immediately
            applyTheme(currentTheme);
            applyLunaSetting(lunaEnabled);

            // If mode changed, reset the whole UI
            if (selectedMode !== oldMode) {
                resetUIForModeChange(selectedMode);
            } else {
                // Mode did not change, just apply widget and engine settings
                applyBodyClasses(currentMode); // Re-apply classes
                applyWidget(currentWidget);
                updateEngineVisibility(currentMode);
            }
        }
        
        function saveListsToCookies() {
            // Save history and bookmarks
            setCookie('orbit-history-list', JSON.stringify(searchHistory), 30);
            setCookie('orbit-bookmarks-list', JSON.stringify(bookmarks), 365);
        }

        function resetUIForModeChange(newMode) {
            tabContainer.innerHTML = '';
            tabContent.innerHTML = '';
            tabCounter = 0;
            activeTabId = null;
            applyBodyClasses(newMode);
            initializeBrowserState();
        }

        function applyBodyClasses(mode) {
            body.classList.remove('mode-classic', 'mode-web-browser', 'mode-privacy-plus');
            
            if (mode === 'web-browser') {
                body.classList.add('mode-web-browser');
                privacyWatermark.classList.add('hidden');
            } else if (mode === 'privacy-plus') {
                body.classList.add('mode-privacy-plus');
                privacyWatermark.classList.remove('hidden');
                // Privacy+ NO LONGER forces theme
            } else { // classic mode
                body.classList.add('mode-classic');
                privacyWatermark.classList.add('hidden');
            }
            // Always apply the user's chosen theme, regardless of mode
            applyTheme(currentTheme);
        }
        
        function applyTheme(theme, forceOled = false) {
             // forceOled parameter is no longer used but kept for compatibility if called elsewhere
             
             // Set body class for theme-specific overrides (like animations)
             body.classList.remove('theme-slate', 'theme-oled', 'theme-cosmic', 'theme-snow');
             body.classList.add(`theme-${theme}`);
             
             // Set CSS variables for all components
             const root = document.documentElement;
             root.style.setProperty('--bg-theme', `var(--bg-${theme})`);
             root.style.setProperty('--container-theme', `var(--container-${theme})`);
             root.style.setProperty('--text-theme', `var(--text-${theme})`);
             root.style.setProperty('--accent-theme', `var(--accent-${theme})`);
             root.style.setProperty('--accent-hover-theme', `var(--accent-hover-${theme})`);
             root.style.setProperty('--border-theme', `var(--border-${theme})`);
             root.style.setProperty('--placeholder-theme', `var(--placeholder-${theme})`);
             root.style.setProperty('--tab-active-theme', `var(--tab-active-${theme})`);
             root.style.setProperty('--tab-inactive-theme', `var(--tab-inactive-${theme})`);
             root.style.setProperty('--tab-hover-theme', `var(--tab-hover-${theme})`);
             root.style.setProperty('--bubble-ai-theme', `var(--bubble-ai-${theme})`);
        }
        
        function applyLunaSetting(enabled) {
            if (enabled) {
                lunaButton.classList.remove('hidden');
            } else {
                lunaButton.classList.add('hidden');
                lunaPanel.classList.remove('open'); // Close panel if it was open
            }
        }

        function updateEngineVisibility(mode) {
            const allNewTabPages = document.querySelectorAll('.new-tab-page');
            const savedEngine = getCookie('orbit-engine') || 'google';

            allNewTabPages.forEach(page => {
                const engineButtons = page.querySelectorAll('.engine-button');
                
                if (mode === 'web-browser') {
                    selectEngine('bing', page);
                    engineButtons.forEach(btn => {
                        btn.disabled = btn.dataset.engine !== 'bing';
                        btn.classList.toggle('opacity-50', btn.disabled);
                        btn.classList.toggle('cursor-not-allowed', btn.disabled);
                    });
                } else if (mode === 'privacy-plus') {
                    selectEngine('startpage', page);
                    engineButtons.forEach(btn => {
                        btn.disabled = btn.dataset.engine !== 'startpage';
                        btn.classList.toggle('opacity-50', btn.disabled);
                        btn.classList.toggle('cursor-not-allowed', btn.disabled);
                    });
                } else {
                    engineButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    });
                    selectEngine(savedEngine, page);
                }
            });
        }


        function loadSettings() {
            // Load Mode
            currentMode = getCookie('orbit-mode') || 'classic';
            
            // Load Theme
            currentTheme = getCookie('orbit-theme') || 'slate';
            
            // Load Toggles
            safeSearchEnabled = true; // Always on
            historyEnabled = getCookie('orbit-history-enabled') !== 'false';
            lunaEnabled = getCookie('orbit-luna-enabled') === 'true';
            forceHttps = getCookie('orbit-force-https') !== 'false';
            
            // Load Widget
            currentWidget = getCookie('orbit-widget') || 'off';
            
            // Load Lists
            try {
                searchHistory = JSON.parse(getCookie('orbit-history-list') || '[]');
            } catch (e) { searchHistory = []; }
            try {
                bookmarks = JSON.parse(getCookie('orbit-bookmarks-list') || '[]');
            } catch (e) { bookmarks = []; }
        }

        // --- Widget Functions ---
        function applyWidget(widget, container) {
            const containers = container ? [container] : document.querySelectorAll('.widget-container');
            containers.forEach(cont => {
                if (!cont) return; 
                cont.innerHTML = '';
                cont.classList.add('h-24');

                if (widget === 'time') {
                    cont.innerHTML = `
                        <div class="time-widget w-full h-full flex flex-col items-center justify-center text-color">
                            <div class="time-display text-6xl font-bold"></div>
                            <div class="date-display text-xl text-color opacity-70"></div>
                        </div>
                    `;
                    updateTimeWidget();
                }
            });
        }
            
        function updateTimeWidget() {
            if (currentWidget !== 'time') return;
            const timeDisplays = document.querySelectorAll('.time-display');
            const dateDisplays = document.querySelectorAll('.date-display');
            if (!timeDisplays.length || !dateDisplays.length) return;

            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });

            timeDisplays.forEach(el => el.textContent = timeString);
            dateDisplays.forEach(el => el.textContent = dateString);
        }

        // --- Tab Functions ---
        function createNewTab(isSearchTab = false, url = "") {
            tabCounter++;
            const tabId = `tab-${tabCounter}`;
            const contentId = `content-${tabCounter}`;
            let content;
            let title = "New Tab ü™ê";

            // --- Create Content ---
            if (isSearchTab) {
                let isBlocked = false;
                title = "Loading...";
                
                if (currentMode === 'web-browser' && forceHttps) {
                    if (url.startsWith('http://') && !url.startsWith('https://')) {
                        isBlocked = true;
                        title = "Blocked";
                    }
                }

                if (isBlocked) {
                    content = document.createElement('div');
                    content.id = contentId;
                    content.className = 'iframe-container w-full h-full hidden flex flex-col items-center justify-center p-8';
                    content.innerHTML = `
                        <div class="text-center p-8 rounded-xl container-bg max-w-md shadow-xl border border-red-700">
                            <span class="material-symbols-outlined text-red-500 text-6xl">lock_open</span>
                            <h3 class="text-2xl font-bold mt-4 text-color">Access Blocked</h3>
                            <p class="text-color opacity-70 mt-2">Orbit is configured to enforce the **HTTPS** security standard. The requested site uses the insecure **HTTP** protocol.</p>
                        </div>
                    `;
                } else {
                    content = document.createElement('div');
                    content.id = contentId;
                    content.className = 'iframe-container w-full h-full hidden';
                    
                    const iframe = document.createElement('iframe');
                    iframe.id = `iframe-${tabId}`;
                    iframe.src = url;
                    // --- Iframe History ---
                    iframe.dataset.history = JSON.stringify([url]);
                    iframe.dataset.historyIndex = 0;
                    iframe.setAttribute('sandbox', 'allow-forms allow-modals allow-popups allow-pointer-lock allow-same-origin allow-scripts');
                    
                    iframe.onload = () => handleIframeLoad(iframe, tabId, contentId);
                    
                    content.appendChild(iframe);
                }

            } else {
                // "New Tab" content
                const template = document.getElementById('new-tab-template');
                content = template.content.firstElementChild.cloneNode(true);
                content.id = contentId;
                content.classList.add('hidden');
                
                initSearchListeners(content);
                applyWidget(currentWidget, content.querySelector('.widget-container'));
                updateEngineVisibility(currentMode);
            }
            
            tabContent.appendChild(content);

            // --- Create Tab Button (if in web-browser mode) ---
            if (currentMode === 'web-browser') {
                const tab = document.createElement('button');
                tab.id = tabId;
                tab.dataset.contentId = contentId;
                tab.className = 'tab-inactive text-sm px-4 py-2 rounded-t-lg relative flex items-center space-x-2 transition-colors duration-150 flex-shrink-0';

                let isClosable = isSearchTab || tabCounter > 1;

                const titleSpan = document.createElement('span');
                titleSpan.className = 'tab-title truncate max-w-[120px] sm:max-w-[150px]';
                titleSpan.textContent = title;
                tab.appendChild(titleSpan);

                if (isClosable) {
                    const closeButton = document.createElement('span');
                    closeButton.className = 'close-tab ml-1 text-color opacity-50 hover:opacity-100 cursor-pointer material-symbols-outlined text-base';
                    closeButton.innerHTML = 'close';
                    closeButton.addEventListener('click', (e) => {
                        e.stopPropagation();
                        closeTab(tabId, contentId);
                    });
                    tab.appendChild(closeButton);
                }

                tab.addEventListener('click', () => {
                    activateTab(contentId);
                });

                tabContainer.appendChild(tab);
            }

            activateTab(contentId);
        }
        
        function handleIframeLoad(iframe, tabId, contentId) {
             const tab = document.getElementById(tabId);
             let titleSpan = tab ? tab.querySelector('.tab-title') : null;
             let newUrl = "";
             let newTitle = "Search Result";
             
             try {
                // This will fail for cross-origin, which is expected
                newUrl = iframe.contentWindow.location.href;
                newTitle = iframe.contentWindow.document.title;
             } catch (e) {
                // Can't access cross-origin iframe. Use src.
                newUrl = iframe.src;
             }
             
             if (newTitle) {
                newTitle = newTitle.substring(0, 20) + (newTitle.length > 20 ? '...' : '');
             }
             if (titleSpan) titleSpan.textContent = newTitle;
             
             // If this is the active tab, update navbar
             if (activeTabId === contentId) {
                navbarSearch.value = newUrl;
                updateNavButtons(iframe);
             }
             
             // Update history
             let history = JSON.parse(iframe.dataset.history);
             let index = parseInt(iframe.dataset.historyIndex, 10);
             
             // If this is a new navigation (not back/fwd)
             if (newUrl !== history[index]) {
                history = history.slice(0, index + 1); // Clear forward history
                history.push(newUrl);
                index = history.length - 1;
                iframe.dataset.history = JSON.stringify(history);
                iframe.dataset.historyIndex = index;
             }
        }
        
        function navigateTo(url, contentId, isNewHistory) {
            const content = document.getElementById(contentId);
            if (!content) return;
            const iframe = content.querySelector('iframe');
            if (!iframe) return;
            
            iframe.src = url; // This will trigger the onload event
            
            // Manually update history if it's a new navigation
            if (isNewHistory) {
                 let history = JSON.parse(iframe.dataset.history);
                 let index = parseInt(iframe.dataset.historyIndex, 10);
                 history = history.slice(0, index + 1);
                 history.push(url);
                 index = history.length - 1;
                 iframe.dataset.history = JSON.stringify(history);
                 iframe.dataset.historyIndex = index;
            }
            
            if (activeTabId === contentId) {
                navbarSearch.value = url;
                updateNavButtons(iframe);
            }
        }
        
        function updateNavButtons(iframe) {
            if (!iframe) {
                navBack.disabled = true;
                navForward.disabled = true;
                return;
            }
            let history = JSON.parse(iframe.dataset.history);
            let index = parseInt(iframe.dataset.historyIndex, 10);
            navBack.disabled = index <= 0;
            navForward.disabled = index >= history.length - 1;
        }

        function activateTab(contentId) {
            if (activeTabId) {
                const oldContent = document.getElementById(activeTabId);
                if (oldContent) oldContent.classList.add('hidden');
                if (currentMode === 'web-browser') {
                    const oldTabButton = document.querySelector(`.tab-active[data-content-id="${activeTabId}"]`);
                    if (oldTabButton) oldTabButton.classList.replace('tab-active', 'tab-inactive');
                }
            }

            const newContent = document.getElementById(contentId);
            
            if (newContent) {
                newContent.classList.remove('hidden');
                activeTabId = contentId;

                if (currentMode === 'web-browser') {
                     const newTabButton = document.querySelector(`[data-content-id="${contentId}"]`);
                     if (newTabButton) {
                        newTabButton.classList.replace('tab-inactive', 'tab-active');
                        // Scroll tab into view
                        newTabButton.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                     }
                     
                     // Update navbar
                     const iframe = newContent.querySelector('iframe');
                     if (iframe) {
                        navbarSearch.value = iframe.src;
                        updateNavButtons(iframe);
                        navReload.disabled = false;
                        navAddBookmark.disabled = false;
                     } else {
                        // "New Tab" page
                        navbarSearch.value = '';
                        updateNavButtons(null);
                        navReload.disabled = true;
                        navAddBookmark.disabled = true;
                     }
                }
                
                if (newContent.classList.contains('new-tab-page')) {
                    const input = newContent.querySelector('.search-input');
                    if (input) input.placeholder = placeholders[placeholderIndex];
                }
            }
        }

        function closeTab(tabId, contentId) {
            const tab = document.getElementById(tabId);
            const content = document.getElementById(contentId);

            if (tab) tab.remove();
            if (content) content.remove();

            if (activeTabId === contentId) {
                const lastTab = tabContainer.lastElementChild;
                if (lastTab) {
                    activateTab(lastTab.dataset.contentId);
                } else {
                    // Closed the last tab, create a new "New Tab"
                    activeTabId = null;
                    createNewTab(false);
                }
            }
        }

        // --- Event Listeners Initialization ---
        function initSearchListeners(container) {
            
            const searchInput = container.querySelector('.search-input');
            const searchButton = container.querySelector('.search-button');
            const messageArea = container.querySelector('.message-area');
            const engineGrid = container.querySelector('.engine-grid');
            
            // New Tab Page Buttons
            const settingsButton = container.querySelector('.new-tab-settings-button');
            const bookmarksButton = container.querySelector('.new-tab-bookmarks-button');
            const historyButton = container.querySelector('.new-tab-history-button');

            if (!searchInput || !searchButton || !messageArea || !engineGrid || !settingsButton || !bookmarksButton || !historyButton) {
                console.error("initSearchListeners: Could not find all required elements.");
                return;
            }

            let savedEngine = getCookie('orbit-engine') || 'google';
            if(currentMode === 'web-browser') savedEngine = 'bing';
            if(currentMode === 'privacy-plus') savedEngine = 'startpage';
            selectEngine(savedEngine, container);
            
            searchInput.placeholder = placeholders[placeholderIndex];

            // Engine button listeners
            engineGrid.querySelectorAll('.engine-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    if (button.disabled) return; 
                    messageArea.classList.add('hidden');
                    currentEngine = button.dataset.engine;
                    setCookie('orbit-engine', currentEngine, 365);
                    
                    document.querySelectorAll('.new-tab-page').forEach(page => {
                        selectEngine(currentEngine, page);
                    });
                });
            });

            searchButton.addEventListener('click', () => {
                performSearch(searchInput.value, currentEngine);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    performSearch(searchInput.value, currentEngine);
                }
            });

            // New Tab Page Button Listeners
            settingsButton.addEventListener('click', openSettings);
            bookmarksButton.addEventListener('click', openBookmarksModal);
            historyButton.addEventListener('click', openHistoryModal);
        }

        function selectEngine(engineId, parentElement) {
            if (!parentElement) return;
            parentElement.querySelectorAll('.engine-button').forEach(btn => {
                btn.classList.remove('selected', 'accent-bg');
            });
            const selectedBtn = parentElement.querySelector(`.engine-button[data-engine="${engineId}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('selected', 'accent-bg');
                currentEngine = engineId;
            }
        }

        // --- Luna AI Functions ---
        function toggleLunaPanel() {
            lunaPanel.classList.toggle('open');
            if (lunaPanel.classList.contains('open')) {
                lunaInput.focus();
            }
        }

        function addMessageToLunaChat(message, sender) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('flex', 'w-full', (sender === 'user' ? 'justify-end' : 'justify-start'), 'mb-4');
            
            const bubble = document.createElement('div');
            bubble.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'text-white', 'break-words');
            
            if (sender === 'user') {
                bubble.classList.add('luna-bubble-user', 'rounded-br-none');
                bubble.textContent = message;
            } else {
                bubble.classList.add('luna-bubble-ai', 'rounded-bl-none');
                bubble.innerHTML = '<span class="opacity-50">...</span>'; // Typing indicator
            }
            
            messageEl.appendChild(bubble);
            lunaChatMessages.appendChild(messageEl);
            lunaChatMessages.scrollTop = lunaChatMessages.scrollHeight;
            return bubble;
        }

        function typeMessage(element, text) {
            let index = 0;
            element.textContent = "";
            
            const intervalId = setInterval(() => {
                if (index < text.length) {
                    element.textContent += text.charAt(index);
                    index++;
                    lunaChatMessages.scrollTop = lunaChatMessages.scrollHeight;
                } else {
                    clearInterval(intervalId);
                }
            }, 30);
        }

        function handleLunaSend() {
            const userMessage = lunaInput.value.trim();
            if (userMessage === '') return;
            addMessageToLunaChat(userMessage, 'user');
            lunaInput.value = '';

            setTimeout(() => {
                const aiBubble = addMessageToLunaChat("", 'ai');
                typeMessage(aiBubble, "I'm working on learning how to understand humans, come back soon.");
            }, 500);
        }
        
        // --- History Modal Functions ---
        function openHistoryModal() {
            historyList.innerHTML = ''; // Clear list
            if (searchHistory.length === 0) {
                historyList.innerHTML = `<p class="text-color opacity-70">No history found.</p>`;
                historyClearButton.disabled = true;
            } else {
                searchHistory.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 rounded-lg border border-color flex justify-between items-center';
                    itemEl.innerHTML = `
                        <div>
                            <span class="text-color font-semibold block">${item.query}</span>
                            <span class="text-xs text-color opacity-50">${new Date(item.timestamp).toLocaleString()}</span>
                        </div>
                        <button data-url="${item.url}" class="history-search-button p-2 accent-bg accent-bg-hover text-white rounded-md text-sm">Go</button>
                    `;
                    historyList.appendChild(itemEl);
                });
                historyClearButton.disabled = false;
            }
            
            historyModal.classList.remove('hidden');
        }
        
        historyList.addEventListener('click', (e) => {
            if (e.target.classList.contains('history-search-button') || e.target.closest('.history-search-button')) {
                const button = e.target.closest('.history-search-button');
                const url = button.dataset.url;
                historyModal.classList.add('hidden');
                
                if (currentMode === 'web-browser') {
                    createNewTab(true, url);
                } else {
                    window.open(url, '_blank');
                }
            }
        });
        
        historyClearButton.addEventListener('click', () => {
            searchHistory = [];
            saveListsToCookies();
            openHistoryModal(); // Refresh modal view
        });

        // --- Bookmarks Modal Functions ---
        function openBookmarksModal() {
            bookmarksList.innerHTML = '';
            if (bookmarks.length === 0) {
                bookmarksList.innerHTML = `<p class="text-color opacity-70">No bookmarks added yet.</p>`;
            } else {
                bookmarks.forEach((item, index) => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'p-3 rounded-lg border border-color flex justify-between items-center';
                    itemEl.innerHTML = `
                        <div>
                            <span class="text-color font-semibold block">${item.title}</span>
                            <a href="${item.url}" target="_blank" class="text-xs text-color opacity-50 block truncate max-w-xs">${item.url}</a>
                        </div>
                        <button data-index="${index}" class="bookmark-remove-button p-1 text-color opacity-50 hover:opacity-100"><span class="material-symbols-outlined">delete</span></button>
                    `;
                    bookmarksList.appendChild(itemEl);
                });
            }
            bookmarksModal.classList.remove('hidden');
        }
        
        bookmarksList.addEventListener('click', (e) => {
             if (e.target.classList.contains('bookmark-remove-button') || e.target.closest('.bookmark-remove-button')) {
                const button = e.target.closest('.bookmark-remove-button');
                const index = parseInt(button.dataset.index, 10);
                bookmarks.splice(index, 1);
                saveListsToCookies();
                openBookmarksModal(); // Refresh
             }
        });
        
        function addBookmark() {
            const content = document.getElementById(activeTabId);
            if (!content) return;
            const iframe = content.querySelector('iframe');
            if (!iframe) return; // Can't bookmark "New Tab"
            
            let url = iframe.src;
            let title = "Bookmark";
            
            const tab = document.querySelector(`[data-content-id="${activeTabId}"]`);
            if (tab) {
                title = tab.querySelector('.tab-title').textContent;
            }
            
            // Check if already bookmarked
            if (bookmarks.some(b => b.url === url)) {
                // Already bookmarked, maybe show a message
                return;
            }
            
            bookmarks.push({ title, url });
            saveListsToCookies();
            // Maybe show a confirmation?
        }

        // --- Function to Setup Initial Browser State based on Mode ---
        function initializeBrowserState() {
            tabContainer.innerHTML = '';
            tabContent.innerHTML = '';
            tabCounter = 0;
            activeTabId = null;

            if (currentMode === 'web-browser') {
                createNewTab(false);
            } else {
                const template = document.getElementById('new-tab-template');
                if (!template) return;
                const content = template.content.firstElementChild.cloneNode(true);
                const contentId = 'content-tab-0';
                content.id = contentId;
                
                tabContent.appendChild(content);
                activateTab(contentId);
                
                initSearchListeners(content);
                applyWidget(currentWidget, content.querySelector('.widget-container'));
                updateEngineVisibility(currentMode);
            }
        }

        // --- Initial Setup Function ---
        function initializeApp() {
            // 1. Load settings from cookies
            loadSettings(); 
            
            // 2. Apply visual theme and mode classes
            applyTheme(currentTheme);
            applyBodyClasses(currentMode);
            applyLunaSetting(lunaEnabled);

            // 3. Initialize the UI based on the loaded mode
            initializeBrowserState(); 

            // 4. Start timers and add global listeners
            startPlaceholderCycling();
            setInterval(updateTimeWidget, 10000); // Update time widget
            updateTimeWidget(); // Run once

            // Settings Listeners
            settingsCloseButton.addEventListener('click', closeSettings);
            settingsSaveButton.addEventListener('click', saveSettings);
            
            // History Modal Listeners
            historyCloseButton.addEventListener('click', () => historyModal.classList.add('hidden'));
            
            // Bookmarks Modal Listeners
            bookmarksCloseButton.addEventListener('click', () => bookmarksModal.classList.add('hidden'));

            // Tab Listeners
            addTabButton.addEventListener('click', () => createNewTab(false));

            // Luna AI Listeners
            lunaButton.addEventListener('click', toggleLunaPanel);
            lunaCloseButton.addEventListener('click', toggleLunaPanel);
lunaSendButton.addEventListener('click', handleLunaSend);
            lunaInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLunaSend();
            });
            
            // Navbar Listeners (Web Browser Mode)
            navSettings.addEventListener('click', openSettings);
            navHistory.addEventListener('click', openHistoryModal);
            navBookmarks.addEventListener('click', openBookmarksModal);
            navAddBookmark.addEventListener('click', addBookmark);
            
            navbarSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleNavbarSearch();
            });
            
            navReload.addEventListener('click', () => {
                const content = document.getElementById(activeTabId);
                const iframe = content ? content.querySelector('iframe') : null;
                if (iframe) iframe.src = iframe.src; // Simple reload
            });
            
            navBack.addEventListener('click', () => {
                const content = document.getElementById(activeTabId);
                const iframe = content ? content.querySelector('iframe') : null;
                if (iframe) {
                    let history = JSON.parse(iframe.dataset.history);
                    let index = parseInt(iframe.dataset.historyIndex, 10);
                    if (index > 0) {
                        index--;
                        iframe.dataset.historyIndex = index;
                        navigateTo(history[index], activeTabId, false);
                    }
                }
            });
            
            navForward.addEventListener('click', () => {
                const content = document.getElementById(activeTabId);
                const iframe = content ? content.querySelector('iframe') : null;
                if (iframe) {
                    let history = JSON.parse(iframe.dataset.history);
                    let index = parseInt(iframe.dataset.historyIndex, 10);
                    if (index < history.length - 1) {
                        index++;
                        iframe.dataset.historyIndex = index;
                        navigateTo(history[index], activeTabId, false);
                    }
                }
            });
        }
        
        // --- START THE APP ---
        initializeApp();

    });
</script>

</body>
</html>
